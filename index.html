<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PZEM-017 Colorful Dashboard</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js" type="text/javascript"></script>
    
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.cdnfonts.com/css/digital-7-mono" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;500;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --bg-gradient: linear-gradient(-45deg, #ee7752, #e73c7e, #23a6d5, #23d5ab);
        }

        body {
            background: var(--bg-gradient);
            background-size: 400% 400%;
            animation: gradientBG 15s ease infinite;
            font-family: 'Poppins', sans-serif;
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            color: white;
        }

        @keyframes gradientBG {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* Header Styles */
        header {
            text-align: center;
            margin-bottom: 30px;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            padding: 20px 40px;
            border-radius: 20px;
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
            border: 1px solid rgba(255, 255, 255, 0.18);
        }

        h1 {
            margin: 0;
            font-weight: 700;
            font-size: 1.8rem;
            text-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        #status {
            margin-top: 10px;
            font-size: 0.9rem;
            font-weight: 500;
            padding: 5px 15px;
            border-radius: 50px;
            display: inline-block;
        }

        .status-connecting { background-color: #f1c40f; color: #333; }
        .status-connected { background-color: #2ecc71; color: white; box-shadow: 0 0 15px #2ecc71; }
        .status-disconnected { background-color: #e74c3c; color: white; }

        /* Dashboard Grid */
        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
            gap: 25px;
            width: 100%;
            max-width: 1200px;
        }

        /* Card Styles */
        .card {
            border-radius: 20px;
            padding: 25px;
            position: relative;
            overflow: hidden;
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            height: 180px;
        }

        .card:hover {
            transform: translateY(-5px) scale(1.02);
            box-shadow: 0 15px 30px rgba(0,0,0,0.3);
        }

        /* Glassmorphism Backgrounds per Card */
        .card-volt {
            background: linear-gradient(135deg, rgba(66, 133, 244, 0.8), rgba(41, 98, 255, 0.6));
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255,255,255,0.2);
        }

        .card-amp {
            background: linear-gradient(135deg, rgba(255, 82, 82, 0.8), rgba(213, 0, 0, 0.6));
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255,255,255,0.2);
        }

        .card-watt {
            background: linear-gradient(135deg, rgba(0, 200, 83, 0.8), rgba(0, 150, 36, 0.6));
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255,255,255,0.2);
        }

        .card-energy {
            background: linear-gradient(135deg, rgba(170, 0, 255, 0.8), rgba(98, 0, 234, 0.6));
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255,255,255,0.2);
        }

        /* Card Content */
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .card-label {
            font-size: 1.1rem;
            font-weight: 500;
            opacity: 0.9;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .card-icon {
            font-size: 2rem;
            opacity: 0.4;
        }

        .value-container {
            text-align: right;
            margin-top: auto;
        }

        .value {
            font-family: 'Digital-7 Mono', monospace;
            font-size: 4.5rem;
            line-height: 1;
            font-weight: 400;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }

        .unit {
            font-family: 'Poppins', sans-serif;
            font-size: 1.2rem;
            font-weight: 300;
            opacity: 0.8;
            margin-left: 5px;
        }

        /* Footer */
        footer {
            margin-top: 50px;
            font-size: 0.8rem;
            opacity: 0.7;
            text-align: center;
        }
        
        /* Responsive tweaks */
        @media (max-width: 600px) {
            .value { font-size: 3.5rem; }
            .card { height: 160px; }
        }
    </style>
</head>
<body>

    <header>
        <h1><i class="fas fa-bolt"></i> Power Monitor</h1>
        <div id="status" class="status-connecting">Connecting...</div>
    </header>

    <div class="dashboard">
        <div class="card card-volt">
            <div class="card-header">
                <span class="card-label">Voltage</span>
                <i class="fas fa-plug card-icon"></i>
            </div>
            <div class="value-container">
                <span id="val-volt" class="value">000</span>
                <span class="unit">V</span>
            </div>
        </div>

        <div class="card card-amp">
            <div class="card-header">
                <span class="card-label">Current</span>
                <i class="fas fa-wave-square card-icon"></i>
            </div>
            <div class="value-container">
                <span id="val-amp" class="value">0.00</span>
                <span class="unit">A</span>
            </div>
        </div>

        <div class="card card-watt">
            <div class="card-header">
                <span class="card-label">Active Power</span>
                <i class="fas fa-lightbulb card-icon"></i>
            </div>
            <div class="value-container">
                <span id="val-watt" class="value">0000</span>
                <span class="unit">W</span>
            </div>
        </div>

        <div class="card card-energy">
            <div class="card-header">
                <span class="card-label">Total Energy</span>
                <i class="fas fa-battery-full card-icon"></i>
            </div>
            <div class="value-container">
                <span id="val-kwh" class="value">000.0</span>
                <span class="unit">kWh</span>
            </div>
        </div>
    </div>

    <footer>
        PZEM-017 DASHBOARD | MQTT WEBSOCKET
    </footer>

    <script>
        // --- KONFIGURASI MQTT ---
        const mqtt_broker = "broker.emqx.io";
        const mqtt_port = 8084; 
        const mqtt_topic = "kampus/pzem017/data";
        const client_id = "colorful_dash_" + Math.random().toString(16).substr(2, 8);

        const client = new Paho.MQTT.Client(mqtt_broker, mqtt_port, client_id);

        function updateStatus(msg, type) {
            const el = document.getElementById("status");
            el.innerHTML = msg;
            el.className = type;
        }

        client.onConnectionLost = function (responseObject) {
            console.log("Connection Lost: " + responseObject.errorMessage);
            updateStatus("Disconnected", "status-disconnected");
        };

        client.onMessageArrived = function (message) {
            console.log("Data: " + message.payloadString);
            
            try {
                const data = JSON.parse(message.payloadString);

                // Update Values
                document.getElementById("val-volt").innerText = parseFloat(data.tegangan).toFixed(0); 
                document.getElementById("val-amp").innerText = parseFloat(data.arus).toFixed(2);
                
                // Animasi kecil saat data masuk: Daya & Energi
                const wattElem = document.getElementById("val-watt");
                wattElem.innerText = parseFloat(data.daya).toFixed(1);
                
                document.getElementById("val-kwh").innerText = parseFloat(data.energi).toFixed(3);

            } catch (e) {
                console.error("Error parsing JSON: ", e);
            }
        };

        const options = {
            useSSL: true,
            timeout: 3,
            onSuccess: function () {
                console.log("MQTT Connected!");
                updateStatus("System Online", "status-connected");
                client.subscribe(mqtt_topic);
            },
            onFailure: function (message) {
                console.log("Connection Failed: " + message.errorMessage);
                updateStatus("Connection Failed", "status-disconnected");
            }
        };

        console.log("Connecting...");
        client.connect(options);
    </script>
</body>
</html>
